<!DOCTYPE html>
<html lang="zh-TW" xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>é¤å»³-FoodieTime é£Ÿåˆ»</title>
<meta name="description"
	content="æ¢ç´¢å„ç¨®æ³°å¼æ–™ç†ï¼Œå°‹æ‰¾æ‚¨å–œæ„›çš„æ³°åœ‹é¢¨å‘³ç¾é£Ÿã€‚FoodieTime é£Ÿåˆ»æä¾›å¤šæ¨£åŒ–çš„æ³°å¼é¤å»³é¸æ“‡ï¼Œæ»¿è¶³æ‚¨çš„å‘³è•¾éœ€æ±‚ã€‚">
<link rel="stylesheet" th:href="@{/css/front/favoritelist/style.css}">
<link rel="stylesheet"
	th:href="@{/css/front/restaurant/restaurant-categories.css}">
<link rel="stylesheet"
	th:href="@{/css/front/restaurant/food-categories.css}">
<link rel="stylesheet"
	th:href="@{/css/front/restaurant/thai-cuisine.css}">
<link rel="stylesheet"
	href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined">
<link
	href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
	rel="stylesheet">

<meta name="theme-color" content="#FF5722">
<link rel="apple-touch-icon" th:href="@{/images/icons/logo.png}">

<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />

</head>
<style>
.restaurant-contact-info {
	display: flex;
	flex-wrap: wrap; /* æ›è¡Œæ™‚è‡ªå‹•å¾€ä¸‹æ’ */
	gap: 12px 20px; /* ä¸Šä¸‹å·¦å³é–“è·ï¼ˆè¡Œè·ã€æ¬„è·ï¼‰ */
	align-items: center;
	font-size: 16px;
}

.restaurant-contact-info .info-item {
	display: flex;
	align-items: center;
	gap: 6px; /* icon èˆ‡æ–‡å­—çš„é–“è· */
	min-width: 180px; /* æ§åˆ¶æ¯ä¸€æ¬„å¯¬åº¦ï¼Œé˜²æ­¢é»åœ¨ä¸€èµ· */
	color: #444;
}

.restaurant-image {
	width: 70%;
	height: 200px;
	object-fit: cover;
	border-radius: 8px;
	margin-right: 20px;
}

.menu-card {
	display: flex;
	flex-wrap: wrap; /* âœ… æ›è¡Œ */
	justify-content: left; /* âœ… æ°´å¹³ç½®ä¸­ï¼ˆä½ å¯æ”¹ space-betweenï¼‰ */
	gap: 20px; /* âœ… å¡ç‰‡é–“è· */
}

.menu-item {
	
}

.menu-item img {
	width: 120px; /* âœ… ä½ å¯ä»¥èª¿æ•´é€™é‚Šå¤§å° */
	height: 120px;
	object-fit: cover; /* âœ… è£åˆ‡å¡«æ»¿ä½†ä¸è®Šå½¢ */
	border-radius: 8px;
	display: block;
}

.modal-product-image {
	width: 265px; /* âœ… å›ºå®šå¯¬åº¦ */
	height: 275px; /* âœ… å›ºå®šé«˜åº¦ï¼šæ­£æ–¹å½¢ */
	object-fit: cover; /* âœ… è£åˆ‡ä½†ä¸è®Šå½¢ */
	border-radius: 8px;
	display: block;
	margin: 0 auto; /* âœ… æ°´å¹³ç½®ä¸­ */
}

.menu-item-info {
	text-align: center;
	width: 100%;
}

.menu-item-name {
	font-size: 18px;
	font-weight: bold;
}

.menu-item-description {
	font-size: 14px;
	color: #777;
	margin: 5px 0;
}

.menu-item-price {
	font-size: 16px;
	color: #c0392b;
	margin: 10px 0;
}

.add-to-cart-btn {
	background-color: #c0392b;
	color: white;
	border: none;
	border-radius: 50%;
	width: 36px;
	height: 36px;
	font-size: 16px;
	cursor: pointer;
	margin-top: 10px;
}

.favorite-btn i.fas.fa-heart {
	color: red;
}

.rating-stars i {
	color: #FFD700; /* é‡‘é»ƒè‰²æ˜Ÿæ˜Ÿ */
	font-size: 1.2em;
	margin-right: 2px;
}
</style>
<body>
	<header th:replace="~{front/common/header :: main-header}"></header>

	<main>
		<section class="page-header">
			<div class="container">
				<h1 class="page-title"
					th:text="${categoryName != null ? categoryName : 'æœå°‹çµæœ'}">åˆ†é¡åç¨±</h1>
				<p class="page-description"
					th:text="'æ¢ç´¢é“åœ°çš„ ' + (${categoryName != null ? categoryName : 'ç¾é£Ÿ'}) + 'ï¼Œå¾å‚³çµ±å°åƒåˆ°ç²¾ç·»æ–™ç†'">
					åˆ†é¡æè¿°</p>
			</div>
		</section>

		<!-- ğŸ” åªæœ‰åœ¨é—œéµå­—æœå°‹æ™‚æ‰é¡¯ç¤ºã€Œæ‰€æœ‰ç›¸é—œæ–™ç†ã€ -->
		<section class="search-products"
			th:if="${param.keyword != null and not #lists.isEmpty(productList)}">
			<h2>ç›¸é—œæ–™ç†</h2>
			<div class="menu-items">
				<div class="menu-item" th:each="prod : ${productList}">
					<img th:src="@{/product/image/{prodId}(prodId=${prod.prodId})}"
						th:alt="${prod.prodName}" class="menu-item-image"
						onerror="this.onerror=null; this.src='/images/restaurant/placeholder.svg';">
					<div class="menu-item-info">
						<h3 class="menu-item-name" th:text="${prod.prodName}">å•†å“åç¨±</h3>
						<p class="menu-item-description" th:text="${prod.prodDesc}">å•†å“æè¿°</p>
						<span class="menu-item-price" th:text="'NT$ ' + ${prod.prodPrice}">åƒ¹æ ¼</span>
					</div>
				</div>
			</div>
		</section>

		<!-- â—æŸ¥ç„¡çµæœé¡¯ç¤º -->
		<div class="container">
			<div
				th:if="${#lists.isEmpty(storeList) and #lists.isEmpty(productList)}"
				style="text-align: center; padding: 2em;">
				<h3>
					æ²’æœ‰ç¬¦åˆã€Œ<span th:text="${param.keyword}">é—œéµå­—</span>ã€çš„çµæœ
				</h3>
				<p>è«‹å˜—è©¦å…¶ä»–é—œéµå­—ã€‚</p>
			</div>
		</div>
		<div class="container">
			<div class="restaurant-list">
				<article class="restaurant-detail" th:each="store : ${storeList}">
					<!-- é¤å»³ä¸»å€å¡Š -->
					<div class="restaurant-header">
						<div class="restaurant-main-info">
							<img
								th:src="'data:image/jpeg;base64,' + ${storeImageMap[store.storId]}"
								th:alt="${store.storName}" class="restaurant-image">
							<div class="restaurant-primary-info">
								<h2 class="restaurant-name" th:text="${store.storName}">é¤å»³åç¨±</h2>
								<span class="cuisine-tag cuisine-thai"
									th:text="${store.storeCate.storCatName}">æ³°å¼æ–™ç†</span>
								<p class="restaurant-category" th:text=${store.storDesc}>æ¹¯å“
									â€¢ ç‚’é£¯ â€¢ æ²™æ‹‰</p>

								<!-- è©•åƒ¹æ˜Ÿæ˜Ÿé–‹å§‹ -->
								<!-- è©•åƒ¹æ˜Ÿæ˜Ÿé–‹å§‹ -->
								<div class="restaurant-rating"
									th:with="starNum=${store.starNum} ?: 0, reviews=${store.reviews} ?: 0">

									<!-- æ˜Ÿæ˜Ÿåœ–ç¤º -->
									<span class="rating-stars" th:if="${reviews > 0}"> <i
										th:each="i : ${#numbers.sequence(1, 5)}"
										th:classappend="${i <= starNum} ? 'fas fa-star' : 'far fa-star'"></i>
									</span>

									<!-- è©•åƒ¹æ•¸ -->
									<span th:if="${reviews > 0}"
										th:text="|${starNum} é¡†æ˜Ÿï¼ˆ${reviews} å‰‡è©•åƒ¹ï¼‰|"></span> <span
										th:if="${reviews == 0}">å°šç„¡è©•åƒ¹</span>
								</div>

								<!-- è©•åƒ¹æ˜Ÿæ˜ŸçµæŸ -->
								<!-- ä¸»é æŒ‰éˆ•åˆ— -->
								<div class="restaurant-actions"></div>
							</div>
						</div>
						<div class="restaurant-contact-info">
							<div class="info-item">
								<i class="fas fa-map-marker-alt"></i><span
									th:text="${store.storAddr}">åœ°å€</span>
							</div>
							<div class="info-item">
								<i class="fas fa-phone"></i><span th:text="${store.storPhone}">é›»è©±</span>
							</div>
							<div class="info-item">
								<i class="fas fa-clock"></i> <span
									th:if="${store.storOffDay != null and weekMap != null}"
									th:text="'ç‡Ÿæ¥­æ™‚é–“: ' + ${store.storOnTime} + ' - ' + ${store.storOffTime} + 'ï¼ˆ' + ${weekMap[store.storOffDay]} + 'å…¬ä¼‘ï¼‰'">
								</span> <span th:unless="${store.storOffDay != null}"
									th:text="'ç‡Ÿæ¥­æ™‚é–“: ' + ${store.storOnTime} + ' - ' + ${store.storOffTime} + 'ï¼ˆå…¬ä¼‘æ—¥ä¸å›ºå®šï¼‰'">
								</span>
							</div>
							<div class="info-item">
								<i class="fa-solid fa-motorcycle"></i> <span
									th:text="${store.storDeliver} == 0 ? 'ç„¡å¤–é€æœå‹™' : 'å¯å¤–é€'"></span>
							</div>
							<div class="info-item"
								th:if="${store.storWeb != null and !store.storWeb.isEmpty()}">
								<i class="fas fa-globe"></i> <a
									th:href="${store.storWeb.startsWith('http') ? store.storWeb : 'http://' + store.storWeb}"
									th:text="${store.storWeb}" class="website-link">ç¶²ç«™é€£çµ</a>
							</div>
						</div>

						<div class="restaurant-details-tabs">
							<div class="tabs-header">
								<button class="tab-btn" data-tab="menu"
									th:data-storeid="${store.storId}">èœå–®</button>
								<button class="tab-btn" data-tab="info"
									th:data-storeid="${store.storId}">åº—å®¶è³‡è¨Š</button>
								<button class="tab-btn" data-tab="coupon"
									th:data-storeid="${store.storId}">å„ªæƒ åˆ¸</button>
							</div>
							<div class="tabs-content">
								<div class="tab-content active"
									th:id="'menu-content-' + ${store.storId}">
									<div class="menu-items">
										<div class="menu-item product-clickable"
											th:each="prod : ${storeProductMap[store.storId]}"
											th:attr="data-prod-id=${prod.prodId},
                                         data-prod-name=${prod.prodName},
                                         data-prod-desc=${prod.prodDesc},
                                         data-prod-price=${prod.prodPrice} ">
											<!--,-->
											<!--                                         data-prod-photo-url=@{/product/image/{prodId}(prodId=${prod.prodId})}">-->
											<img
												th:src="@{/product/image/{prodId}(prodId=${prod.prodId})}"
												th:alt="${prod.prodName}" class="menu-item-image"
												onerror="this.onerror=null; this.src='/images/restaurant/placeholder.svg';">
											<div class="menu-item-info">
												<h3 class="menu-item-name" th:text="${prod.prodName}">å•†å“åç¨±</h3>
												<p class="menu-item-description" th:text="${prod.prodDesc}">å•†å“æè¿°</p>
												<span class="menu-item-price"
													th:text="'NT$ ' + ${prod.prodPrice}">åƒ¹æ ¼</span>
											</div>

											<button class="favorite-btn favorite-product-btn"
												th:data-prodid="${prod.prodId}">
												<i
													th:classappend="${favoriteProdIds != null and favoriteProdIds.contains(prod.prodId)} ? 'fas fa-heart' : 'far fa-heart'"
													th:style="${favoriteProdIds != null and favoriteProdIds.contains(prod.prodId)} ? 'color:red' : ''"></i>
												æ”¶è—
											</button>
										</div>

									</div>

								</div>
								<!-- åº—å®¶è³‡è¨Š Tabå…§å®¹ -->
								<div class="tab-content"
									th:id="'info-content-' + ${store.storId}">
									<div class="info-section">
										<h3 class="info-title">åº—å®¶ä½ç½®</h3>
										<p>
											<strong th:text="${store.storName}">åº—å®¶åç¨±</strong>
										</p>
										<p th:text="${store.storAddr}">åº—å®¶åœ°å€</p>

										<div class="map-container" style="margin-top: 1em;">
											<!-- æœ‰åº§æ¨™æ™‚é¡¯ç¤º Google åœ°åœ– -->
											<iframe
												th:if="${store.storLat != null and store.storLon != null}"
												width="100%" height="300" frameborder="0" style="border: 0"
												allowfullscreen loading="lazy"
												referrerpolicy="no-referrer-when-downgrade"
												th:src="'https://www.google.com/maps?q=' + ${store.storLat} + ',' + ${store.storLon} + '&hl=zh-TW&z=16&output=embed'">
											</iframe>

											<!-- æ²’æœ‰åº§æ¨™é¡¯ç¤ºé è¨­åœ– -->
											<img
												th:unless="${store.storLat != null and store.storLon != null}"
												src="/images/map-placeholder.svg" alt="é è¨­åœ°åœ–"
												style="width: 100%; height: 300px; object-fit: cover; border-radius: 8px;" />
										</div>
									</div>
								</div>
								<!-- â• æ–°å¢å„ªæƒ åˆ¸å…§å®¹ (æ›´å‹•å¾Œç‰ˆ) -->
								<div class="tab-content" th:id="'coupon-content-' + ${store.storId}">

									<!-- 1. ä½¿ç”¨ Grid ä½ˆå±€å®¹å™¨ -->
									<div class="coupon-grid">

										<!-- å¦‚æœåº—å®¶æ²’æœ‰ä»»ä½•å„ªæƒ åˆ¸ï¼Œé¡¯ç¤ºæç¤ºè¨Šæ¯ -->
										<div th:if="${storeCouponMap == null or #lists.isEmpty(storeCouponMap[store.storId])}" class="coupon-empty-message">
											<p>ç›®å‰æ²’æœ‰å¯ç”¨çš„å„ªæƒ åˆ¸å–”ï¼</p>
										</div>

										<!-- 2. è¿­ä»£å„ªæƒ åˆ¸ï¼Œä¸¦ç‚ºæ¯å¼µåˆ¸å»ºç«‹å¡ç‰‡ -->
										<div th:each="coupon : ${storeCouponMap[store.storId]}"
											 class="coupon-card"
											 th:with="
                now = ${serverTime.toInstant()},
                startDate = ${coupon.couStartDate.toInstant()},
                endDate = ${coupon.couEndDate.toInstant()},
                isExpired = ${now.isAfter(endDate)},
                isNotStarted = ${now.isBefore(startDate)},
                isClaimed = ${claimedCouponIds != null and #lists.contains(claimedCouponIds, coupon.couId)},
                isUnavailable = ${isExpired or isNotStarted}
             "
											 th:classappend="${isUnavailable or isClaimed} ? 'disabled' : ''">

											<!-- å„ªæƒ åˆ¸æ–‡å­—è³‡è¨Š -->
											<div class="coupon-info">
												<h3 class="menu-item-name" th:text="${coupon.couName}">å„ªæƒ åˆ¸åç¨±</h3>
												<p class="menu-item-description" th:text="${coupon.couDesc}">å„ªæƒ åˆ¸èªªæ˜</p>
												<span class="menu-item-price" th:text="'æ»¿ ' + ${coupon.couMinOrd} + ' å…ƒå¯ä½¿ç”¨'">æœ€ä½æ¶ˆè²»é‡‘é¡</span>
											</div>

											<!-- 3. æ ¹æ“šä¸åŒç‹€æ…‹é¡¯ç¤ºå°æ‡‰çš„æŒ‰éˆ• -->
											<div class="coupon-action">
												<!-- ç‹€æ…‹ A: å¯é ˜å– -->
												<button th:if="${!isUnavailable and !isClaimed}"
														type="button"
														class="coupon-claim-btn favorite-coupon-btn"
														th:data-couid="${coupon.couId}">
													<i class="far fa-heart"></i> é ˜å–
												</button>

												<!-- ç‹€æ…‹ B: å·²é ˜å– -->
												<button th:if="${isClaimed}" type="button" class="coupon-claim-btn" disabled>
													<i class="fas fa-check-circle"></i> å·²é ˜å–
												</button>

												<!-- ç‹€æ…‹ C: å°šæœªé–‹æ”¾ -->
												<button th:if="${isNotStarted}" type="button" class="coupon-claim-btn" disabled>
													<i class="fas fa-hourglass-start"></i> å°šæœªé–‹æ”¾
												</button>

												<!-- ç‹€æ…‹ D: å·²éæœŸ -->
												<button th:if="${isExpired}" type="button" class="coupon-claim-btn" disabled>
													<i class="fas fa-calendar-times"></i> å·²éæœŸ
												</button>
											</div>
										</div>
									</div>
								</div>
								<!-- ==================== /å„ªæƒ åˆ¸é …ç›®å€å¡Š ==================== -->

							</div>

						</div>

					</div>
				</article>
			</div>
		</div>
	</main>

	<footer th:replace="~{front/common/footer :: main-footer}"></footer>
	<!-- ==================== å•†å“ç‡ˆç®± (Modal) çµæ§‹ ============================================================ -->
	<!-- ==================== å•†å“ç‡ˆç®± (Modal) çµæ§‹ ============================================================ -->
	<!-- ================================================================================================== -->

	<!-- å•†å“ç‡ˆç®± (Modal) çµæ§‹ (æ­¤éƒ¨åˆ†ç¶­æŒä¸è®Š) -->
	<div class="product-modal-overlay" id="productModalOverlay">
		<!-- ... å…§éƒ¨çµæ§‹çœç•¥ï¼Œç¶­æŒåŸæ¨£ ... -->
		<div class="product-modal-content">
			<button class="modal-close-btn" id="modalCloseBtn">&times;</button>
			<div class="modal-body">
				<div class="modal-product-image-container">
					<img id="modalProductImage" src="" alt="å•†å“åœ–ç‰‡"
						 class="modal-product-image">
				</div>
				<div class="modal-product-info">
					<h2 id="modalProductName" class="modal-product-name">å•†å“åç¨±</h2>
					<p id="modalProductDesc" class="modal-product-description">å•†å“æè¿°æœƒé¡¯ç¤ºåœ¨é€™è£¡ã€‚</p>
					<div class="modal-price-and-controls">
						<span id="modalProductPrice" class="modal-product-price">NT$
							0</span>
						<div class="quantity-controls">
							<button class="quantity-btn" id="quantityDecrement">-</button>
							<input type="number" id="quantityInput" class="quantity-input"
								   value="1" min="1" max="99" readonly>
							<button class="quantity-btn" id="quantityIncrement">+</button>
						</div>
					</div>
					<button id="addToCartBtn" class="btn btn-primary btn-add-to-cart">
						<span>åŠ å…¥è³¼ç‰©è»Š - NT$ 0</span>
					</button>
				</div>
			</div>
		</div>
	</div>

	<!-- ==================== ç™»å…¥æç¤ºç‡ˆç®± (æ”¶è—ç”¨) ==================== -->
	<div id="login-prompt-modal"
		 style="display: none; position: fixed; z-index: 9999; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0, 0, 0, 0.5); align-items: center; justify-content: center;">
		<div
				style="background: #fff; padding: 2em; border-radius: 10px; text-align: center; max-width: 300px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);">
			<h3>âš ï¸ è«‹å…ˆç™»å…¥æœƒå“¡</h3>
			<p style="margin: 1em 0;">æ‚¨å¿…é ˆç™»å…¥æœƒå“¡æ‰èƒ½åŠ å…¥æ”¶è—æ¸…å–®ã€‚</p>
			<div style="margin-top: 1em;">
				<div class="modal-button-container">
					<div class="modal-button-container">
						<button class="modal-button btn-secondary" id="closeLoginPromptBtn">å–æ¶ˆ</button>
						<button class="modal-button btn-primary" onclick="location.href='/front/member/login'">ç«‹å³ç™»å…¥</button>
					</div>

				</div>
			</div>
		</div>
	</div>

	<!-- ==================== åŠ å…¥è³¼ç‰©è»Šç”¨çš„æç¤ºç‡ˆç®± ==================== -->
	<div id="login-prompt-modal-buy"
		 style="display: none; position: fixed; z-index: 9999; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0, 0, 0, 0.5); align-items: center; justify-content: center;">
		<div style="background: #fff; padding: 2em; border-radius: 10px; text-align: center; max-width: 300px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);">
			<h3>âš ï¸ è«‹å…ˆç™»å…¥æœƒå“¡</h3>
			<p style="margin: 1em 0;">æ‚¨å¿…é ˆç™»å…¥æœƒå“¡æ‰èƒ½å°‡å•†å“åŠ å…¥è³¼ç‰©è»Šã€‚</p>
			<div class="modal-button-container">
				<button class="modal-button btn-secondary" id="closeLoginPromptBuyBtn">å–æ¶ˆ</button>
				<button class="modal-button btn-primary" onclick="location.href='/front/member/login'">ç«‹å³ç™»å…¥</button>
			</div>
		</div>
	</div>

	<!-- Toast æç¤ºè¨Šæ¯ (ç¶­æŒä¸è®Š) -->
	<div id="toast-message"
		 style="position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background-color: #444; color: #fff; padding: 10px 20px; border-radius: 8px; display: none; font-size: 16px; z-index: 9999;">
	</div>

	<!-- ==================== JavaScript ä¿®æ­£ ==================== -->
	<script>
		document.addEventListener('DOMContentLoaded', function () {
			// ==================== åŸæœ‰çš„æ‰€æœ‰ Fetch é‚è¼¯ç¶­æŒä¸è®Š ====================
			// (æ”¶è—å•†å“, é ˜å–å„ªæƒ åˆ¸, Tabåˆ‡æ›, å•†å“ç‡ˆç®±, åŠ å…¥è³¼ç‰©è»Š... ç­‰é‚è¼¯éƒ½ç¶­æŒåŸæ¨£)
			// ...
			// ... æ­¤è™•çœç•¥æ‚¨åŸæœ¬çš„ fetch ç¨‹å¼ç¢¼ï¼Œè«‹ä¿ç•™å®ƒå€‘ ...
			// ...

			// æ”¶è—å•†å“åŠŸèƒ½
			document.querySelectorAll('.favorite-product-btn').forEach(btn => {
				btn.addEventListener('click', function (e) {
					e.stopPropagation(); // é˜²æ­¢è§¸ç™¼çˆ¶å±¤çš„å•†å“é»æ“Šäº‹ä»¶
					const prodId = this.dataset.prodid;
					const icon = this.querySelector('i');
					const isFavorited = icon.classList.contains('fas');
					const url = isFavorited ? '/favorite/remove' : '/favorite/add';

					fetch(url, {
						method: 'POST',
						headers: {'Content-Type': 'application/json'},
						body: JSON.stringify({prodId})
					})
							.then(async res => {
								if (res.url.includes("/front/member/login")) {
									showLoginPrompt();
									throw new Error("æœªç™»å…¥(æ”¶è—)");
								}
								if (!res.ok) {
									const err = await res.json().catch(() => ({ error: "åŠ å…¥æ”¶è—å¤±æ•—" }));
									throw new Error(err.error);
								}
								return res.json();
							})
							.then(data => {
								icon.classList.toggle('fas', !isFavorited);
								icon.classList.toggle('far', isFavorited);
								icon.style.color = isFavorited ? '' : 'red';
								showToast(isFavorited ? 'å·²å–æ¶ˆæ”¶è—' : 'å·²åŠ å…¥æ”¶è—');
							})
							.catch(err => {
								if (err.message && !err.message.includes("æœªç™»å…¥")) {
									alert("éŒ¯èª¤ï¼š" + err.message);
								}
							});
				});
			});

			// é ˜å–å„ªæƒ åˆ¸åŠŸèƒ½
			document.querySelectorAll('.favorite-coupon-btn').forEach(btn => {
				btn.addEventListener('click', function () {
					const couponId = this.dataset.couid;
					const button = this;

					fetch('/member/coupons/claim', {
						method: 'POST',
						headers: {'Content-Type': 'application/json'},
						body: JSON.stringify({ couponId })
					})
							.then(async res => {
								if (res.url.includes("/front/member/login")) {
									showLoginPrompt();
									throw new Error("æœªç™»å…¥(é ˜åˆ¸)");
								}
								const data = await res.json();
								if (!res.ok) {
									throw new Error(data.message || "é ˜å–å¤±æ•—");
								}
								return data;
							})
							.then(data => {
								if (data.success) {
									showToast('å„ªæƒ åˆ¸é ˜å–æˆåŠŸï¼');
									button.disabled = true;
									button.innerHTML = '<i class="fas fa-check-circle"></i> å·²é ˜å–';
									button.classList.add('claimed');
								} else {
									showToast(data.message || 'é ˜å–å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
								}
							})
							.catch(error => {
								if (error.message && !error.message.includes("æœªç™»å…¥")) {
									console.error('é ˜å–å„ªæƒ åˆ¸æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
									alert('éŒ¯èª¤ï¼š' + error.message);
								}
							});
				});
			});

			// Tab åˆ‡æ›åŠŸèƒ½
			document.querySelectorAll('.restaurant-detail').forEach(restaurantCard => {
				restaurantCard.querySelectorAll('.tab-btn').forEach(btn => {
					btn.addEventListener('click', function () {
						const storeId = this.dataset.storeid;
						const tab = this.dataset.tab;
						restaurantCard.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
						restaurantCard.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
						this.classList.add('active');
						const contentId = `${tab}-content-${storeId}`;
						const newContent = restaurantCard.querySelector(`#${contentId}`);
						if (newContent) newContent.classList.add('active');
					});
				});
			});

			// å•†å“ç‡ˆç®± (Modal) ç›¸é—œé‚è¼¯
			const modalOverlay = document.getElementById('productModalOverlay');
			const modalCloseBtn = document.getElementById('modalCloseBtn');
			const modalImage = document.getElementById('modalProductImage');
			const modalName = document.getElementById('modalProductName');
			const modalDesc = document.getElementById('modalProductDesc');
			const modalPrice = document.getElementById('modalProductPrice');
			const quantityInput = document.getElementById('quantityInput');
			const quantityDecrement = document.getElementById('quantityDecrement');
			const quantityIncrement = document.getElementById('quantityIncrement');
			const addToCartBtn = document.getElementById('addToCartBtn');
			let currentProductPrice = 0;
			let currentProdId = null;

			document.querySelector('.restaurant-list').addEventListener('click', e => {
				const productCard = e.target.closest('.product-clickable');
				if (productCard) {
					e.preventDefault();
					openProductModal(productCard);
				}
			});

			function openProductModal(productCard) {
				const data = productCard.dataset;
				currentProdId = parseInt(data.prodId, 10);
				currentProductPrice = parseFloat(data.prodPrice);
				modalImage.src = `/product/image/${data.prodId}`;
				modalImage.alt = data.prodName;
				modalImage.onerror = () => { modalImage.src = '/images/restaurant/placeholder.svg'; };
				modalName.textContent = data.prodName;
				modalDesc.textContent = data.prodDesc;
				modalPrice.textContent = `NT$ ${currentProductPrice}`;
				quantityInput.value = 1;
				updateAddToCartButton();
				modalOverlay.classList.add('active');
			}

			function closeProductModal() { modalOverlay.classList.remove('active'); }

			function updateAddToCartButton() {
				const quantity = parseInt(quantityInput.value, 10);
				const totalPrice = currentProductPrice * quantity;
				addToCartBtn.querySelector('span').textContent = `åŠ å…¥è³¼ç‰©è»Š - NT$ ${totalPrice}`;
			}

			modalCloseBtn.addEventListener('click', closeProductModal);
			modalOverlay.addEventListener('click', e => { if (e.target === modalOverlay) closeProductModal(); });
			quantityIncrement.addEventListener('click', () => {
				let val = parseInt(quantityInput.value, 10);
				if (val < 99) { quantityInput.value = val + 1; updateAddToCartButton(); }
			});
			quantityDecrement.addEventListener('click', () => {
				let val = parseInt(quantityInput.value, 10);
				if (val > 1) { quantityInput.value = val - 1; updateAddToCartButton(); }
			});

			addToCartBtn.addEventListener('click', function() {
				const formData = new URLSearchParams();
				formData.append('prodId', currentProdId);
				formData.append('quantity', quantityInput.value);

				fetch('/cart/api/add', {
					method: 'POST',
					headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
					body: formData
				})
						.then(async response => {
							if (response.url.includes("/front/member/login")) {
								showLoginPromptForBuy();
								throw new Error('User not logged in (buy)');
							}
							const data = await response.json();
							if (!response.ok) {
								throw new Error(data.message || 'åŠ å…¥è³¼ç‰©è»Šå¤±æ•—');
							}
							return data;
						})
						.then(data => {
							closeProductModal();
							showToast(data.message || 'æˆåŠŸåŠ å…¥è³¼ç‰©è»Š');
						})
						.catch(error => {
							if (error.message && !error.message.includes('User not logged in')) {
								console.error('åŠ å…¥è³¼ç‰©è»Šæ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
								alert(error.message);
							}
						});
			});

			// ==================== ç™»å…¥æç¤ºæ¡†ç›¸é—œå‡½å¼ (å‡½å¼å®šç¾©ä¸è®Š) ====================
			function showLoginPrompt() {
				sessionStorage.setItem('redirectAfterLogin', window.location.href);
				document.getElementById('login-prompt-modal').style.display = 'flex';
			}

			function closeLoginPrompt() {
				document.getElementById('login-prompt-modal').style.display = 'none';
			}

			function showLoginPromptForBuy() {
				closeProductModal();
				sessionStorage.setItem('redirectAfterLogin', window.location.href);
				document.getElementById('login-prompt-modal-buy').style.display = 'flex';
			}

			function closeLoginPromptForBuy() {
				document.getElementById('login-prompt-modal-buy').style.display = 'none';
			}

			function showToast(message) {
				const toast = document.getElementById('toast-message');
				toast.textContent = message;
				toast.style.display = 'block';
				setTimeout(() => { toast.style.display = 'none'; }, 2000);
			}

			// â˜…â˜… æ­¥é©Ÿ2: åœ¨é€™è£¡ç‚ºå…©å€‹å–æ¶ˆæŒ‰éˆ•åŠ ä¸Šäº‹ä»¶ç›£è½ â˜…â˜…
			document.getElementById('closeLoginPromptBtn').addEventListener('click', closeLoginPrompt);
			document.getElementById('closeLoginPromptBuyBtn').addEventListener('click', closeLoginPromptForBuy);
		});
	</script>

</body>
</html>