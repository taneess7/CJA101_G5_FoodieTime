<!DOCTYPE html>
<html lang="zh-TW" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>一般訂單詳情檢視 - 後台管理系統</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <!-- 自訂CSS -->
  <link rel="stylesheet" th:href="@{/css/admin/admin-style.css}">
  <!-- DataTables CSS -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.min.css">
</head>
<body>
<!-- Sidebar (維持不變) -->
<div class="sidebar">
  <div class="logo text-center">
    <img src="https://via.placeholder.com/150x50?text=FoodieTime" alt="FoodieTime Logo">
  </div>
  <ul class="nav flex-column">
    <li class="nav-item">
      <a class="nav-link" th:href="@{/smg/admin-dashboard}">
        <i class="fas fa-tachometer-alt"></i>
        <span>儀表板</span>
      </a>
    </li>

    <li class="nav-item section-title">討論區管理</li>
    <li class="nav-item">
      <a class="nav-link" th:href="@{/smg/admin-forum-reports}">
        <i class="fas fa-flag"></i>
        <span>檢舉審核管理</span>
      </a>
    </li>

    <li class="nav-item section-title">管理員管理</li>
    <li class="nav-item">
      <a class="nav-link" th:href="@{/smg/admin-users-add}">
        <i class="fas fa-user-plus"></i>
        <span>新增管理員</span>
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link" th:href="@{/smg/admin-users-permissions}">
        <i class="fas fa-user-shield"></i>
        <span>管理員權限管理</span>
      </a>
    </li>

    <li class="nav-item section-title">商家管理</li>
    <li class="nav-item">
      <a class="nav-link" th:href="@{/smg/admin-vendors-review}">
        <i class="fas fa-check-circle"></i>
        <span>審核商家</span>
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link"th:href="@{/smg/admin-vendors-edit}">
        <i class="fas fa-store-alt"></i>
        <span>商家帳號查詢/編輯</span>
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link" th:href="@{/smg/admin-vendors-reports}">
        <i class="fas fa-flag"></i>
        <span>檢舉功能</span>
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link" th:href="@{/smg/admin-vendors-blacklist}">
        <i class="fas fa-ban"></i>
        <span>黑名單管理</span>
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link" th:href="@{/smg/admin-products-disable}">
        <i class="fas fa-times-circle"></i>
        <span>下架商品</span>
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link" th:href="@{/smg/admin-vendors-permissions}">
        <i class="fas fa-key"></i>
        <span>權限變更</span>
      </a>
    </li>

    <li class="nav-item section-title">會員管理</li>
    <li class="nav-item">
      <a class="nav-link" th:href="@{/smg/admin-members-search}">
        <i class="fas fa-users"></i>
        <span>會員查詢與篩選</span>
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link" th:href="@{/smg/admin-members-permissions}">
        <i class="fas fa-user-cog"></i>
        <span>權限變更</span>
      </a>
    </li>

    <li class="nav-item section-title">團購管理</li>
    <li class="nav-item">
      <a class="nav-link" th:href="@{/smg/admin-groups-reports}">
        <i class="fas fa-flag"></i>
        <span>檢舉審核管理</span>
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link" th:href="@{/smg/admin-groups-status}">
        <i class="fas fa-toggle-on"></i>
        <span>啟用/停用</span>
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link" th:href="@{/smg/admin-groups-orders}">
        <i class="fas fa-clipboard-list"></i>
        <span>訂單詳情檢視</span>
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link" th:href="@{/smg/admin-groups-payments}">
        <i class="fas fa-money-bill-wave"></i>
        <span>付款處理</span>
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link" th:href="@{/smg/admin-groups-refunds}">
        <i class="fas fa-undo"></i>
        <span>退款</span>
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link" th:href="@{/smg/admin-groups-monthly}">
        <i class="fas fa-calendar-alt"></i>
        <span>月結付款</span>
      </a>
    </li>

    <li class="nav-item section-title">一般訂單管理</li>
    <li class="nav-item">
      <a class="nav-link active" th:href="@{/smg/admin-orders-view}">
        <i class="fas fa-shopping-cart"></i>
        <span>訂單詳情檢視</span>
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link" th:href="@{/smg/admin-orders-payments}">
        <i class="fas fa-credit-card"></i>
        <span>付款處理</span>
      </a>
    </li>

    <li class="nav-item section-title">客服管理</li>
    <li class="nav-item">
      <a class="nav-link" th:href="@{/smg/admin-service-tickets}">
        <i class="fas fa-headset"></i>
        <span>表單回覆</span>
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link logout-btn" href="#">
        <i class="fas fa-sign-out-alt"></i>
        <span>登出</span>
      </a>
    </li>
  </ul>
</div>

<!-- Main Content (維持不變) -->
<div class="main-content">
  <!-- Top Navigation (維持不變) -->
  <div class="top-nav">
    <button class="btn btn-sm btn-outline-secondary sidebar-toggle d-lg-none">
      <i class="fas fa-bars"></i>
    </button>
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb mb-0">
        <li class="breadcrumb-item"><a th:href="@{/smg/admin-dashboard}">儀表板</a></li>
        <li class="breadcrumb-item">訂單管理</li>
        <li class="breadcrumb-item active" aria-current="page">訂單詳情檢視</li>
      </ol>
    </nav>
    <div class="user-dropdown dropdown">
      <a class="btn btn-sm btn-outline-secondary dropdown-toggle d-flex align-items-center" href="#"
         role="button" id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false">
        <img src="https://randomuser.me/api/portraits/men/41.jpg" alt="用戶頭像" class="user-avatar me-2">
        <span class="user-name" th:text="${session.loggedInSmg.smgrAccount}">系統管理員</span>
      </a>
      <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
        <li><a class="dropdown-item" href="#"><i class="fas fa-user"></i> 個人資料</a></li>
        <li><a class="dropdown-item" href="#"><i class="fas fa-cog"></i> 設定</a></li>
        <li><hr class="dropdown-divider"></li>
        <li><a class="dropdown-item logout-btn" href="#"><i class="fas fa-sign-out-alt"></i> 登出</a></li>
      </ul>
    </div>
  </div>

  <!-- Page Content (主列表維持不變) -->
  <div class="container-fluid">
    <div class="row">
      <div class="col-12">
        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="fas fa-shopping-cart me-2"></i>一般訂單詳情檢視</h5>
            <a style="text-decoration: none;"class="btn-custom"th:href="@{/act/listAllAct}">全站活動</a>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-hover datatable">
                <thead class="table-light">
                <tr>
                  <th>訂單編號</th>
                  <th>店家資訊</th>
                  <th>會員資訊</th>
                  <th>訂單時間</th>
                  <th>實付金額</th>
                  <th>訂單狀態</th>
                  <th>付款狀態</th>
                  <th>取餐方式</th>
                  <th>操作</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="order : ${ordersList}">
                  <td class="fw-bold" th:text="${order.ordId}"></td>
                  <td>
                    <div class="d-flex align-items-center">
                      <div>
                        <div class="fw-bold" th:text="${order.store.storName}"></div>
                        <small class="text-muted" th:text="'ID: ' + ${order.store.storId}"></small>
                      </div>
                    </div>
                  </td>
                  <td>
                    <div class="fw-bold" th:text="${order.member.memName}"></div>
                    <small class="text-muted" th:text="'ID: ' + ${order.member.memId}"></small>
                  </td>
                  <td th:text="${order.ordDate == null ? '' : #temporals.format(order.ordDate.toLocalDateTime(), 'yyyy-MM-dd HH:mm')}"></td>
                  <td class="fw-bold text-success" th:text="'NT$ ' + ${order.actualPayment}"></td>
                  <td>
                    <span class="badge bg-secondary" th:if="${order.orderStatus == 0}">未接單</span>
                    <span class="badge bg-primary" th:if="${order.orderStatus == 1}">已接單</span>
                    <span class="badge bg-info" th:if="${order.orderStatus == 2}">準備中</span>
                    <span class="badge bg-success" th:if="${order.orderStatus == 3}">已完成</span>
                    <span class="badge bg-danger" th:if="${order.orderStatus == 4}">已取消</span>
                  </td>
                  <td>
                    <span class="badge bg-warning text-dark" th:if="${order.paymentStatus == 0}">未付款</span>
                    <span class="badge bg-success" th:if="${order.paymentStatus == 1}">已付款</span>
                    <span class="badge bg-danger" th:if="${order.paymentStatus == 2}">退款中</span>
                  </td>
                  <td>
                    <span class="badge bg-info" th:if="${order.deliver == 0}">外送</span>
                    <span class="badge bg-primary" th:if="${order.deliver == 1}">自取</span>
                  </td>
                  <td>
                    <button class="btn btn-sm btn-outline-primary me-1" th:onclick="|viewOrder('${order.ordId}')|">
                      <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-warning" th:onclick="|editOrder('${order.ordId}')|">
                      <i class="fas fa-edit"></i>
                    </button>
                  </td>
                </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- View Order Modal (★ 此處為主要修改點) -->
<div class="modal fade" id="viewOrderModal" tabindex="-1" aria-labelledby="viewOrderModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="viewOrderModalLabel">訂單詳細資訊</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="col-lg-4">
            <h6><i class="fas fa-receipt me-2"></i>訂單基本資訊</h6>
            <table class="table table-sm table-borderless">
              <tr><td class="fw-bold" style="width: 100px;">訂單編號</td><td id="modalOrderId"></td></tr>
              <tr><td class="fw-bold">訂單狀態</td><td id="modalOrderStatus"></td></tr>
              <tr><td class="fw-bold">付款狀態</td><td id="modalPaymentStatus"></td></tr>
              <tr><td class="fw-bold">訂單時間</td><td id="modalOrderTime"></td></tr>
              <tr><td class="fw-bold">付款方式</td><td id="modalPayMethod"></td></tr>
              <tr><td class="fw-bold">取餐方式</td><td id="modalDeliver"></td></tr>
            </table>
          </div>
          <div class="col-lg-4">
            <h6><i class="fas fa-user me-2"></i>會員與店家</h6>
            <table class="table table-sm table-borderless">
              <tr><td class="fw-bold" style="width: 100px;">會員姓名</td><td id="modalMemberName"></td></tr>
              <tr><td class="fw-bold">會員編號</td><td id="modalMemberId"></td></tr>
              <tr><td class="fw-bold">店家名稱</td><td id="modalStoreName"></td></tr>
              <tr><td class="fw-bold">店家編號</td><td id="modalStoreId"></td></tr>
            </table>
          </div>
          <div class="col-lg-4">
            <h6><i class="fas fa-dollar-sign me-2"></i>金額資訊</h6>
            <table class="table table-sm table-borderless">
              <tr><td class="fw-bold" style="width: 120px;">訂單總額</td><td id="modalOrderSum"></td></tr>
              <tr><td class="fw-bold">活動折扣</td><td id="modalPromoDiscount"></td></tr>
              <tr><td class="fw-bold">優惠券折扣</td><td id="modalCouponDiscount"></td></tr>
              <tr class="fw-bold text-success"><td class="fw-bold">實付金額</td><td id="modalActualPayment"></td></tr>
            </table>
          </div>
        </div>
        <hr>
        <!-- ★ 訂單明細表格結構修改 -->
        <div class="row mt-3">
          <div class="col-12">
            <h6><i class="fas fa-list-alt me-2"></i>訂單商品明細</h6>
            <div class="table-responsive">
              <table class="table table-bordered">
                <thead class="table-light">
                <tr>
                  <th>商品名稱</th>
                  <th>規格/備註</th>
                  <th>商品單價</th>
                  <th>商品數量</th>
                  <th>小計</th>
                </tr>
                </thead>
                <!-- ★ 給予tbody一個id，方便JS操作 -->
                <tbody id="modalOrderDetailsBody">
                <!-- 明細將由JS動態生成 -->
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="row mt-3">
          <div class="col-md-6">
            <h6><i class="fas fa-map-marker-alt me-2"></i>收件資訊</h6>
            <div class="card">
              <div class="card-body">
                <p class="mb-1"><strong>外送地址:</strong> <span id="modalOrdAddr"></span></p>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <h6><i class="fas fa-comment me-2"></i>評價與備註</h6>
            <div class="card">
              <div class="card-body">
                <p class="mb-1"><strong>評價:</strong> <span id="modalRating"></span></p>
                <p class="mb-0"><strong>內容:</strong> <span id="modalComment"></span></p>
                <p class="mb-0"><strong>取消原因:</strong> <span id="modalCancelReason"></span></p>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
        <button type="button" class="btn btn-warning" onclick="editOrderFromModal()">編輯訂單</button>
      </div>
    </div>
  </div>
</div>

<!-- Edit Order Modal (維持不變) -->
<div class="modal fade" id="editOrderModal" tabindex="-1" aria-labelledby="editOrderModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editOrderModalLabel">編輯訂單狀態</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="editOrderForm">
          <input type="hidden" id="editOrdId" name="ordId">
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="editOrderStatus" class="form-label">訂單狀態</label>
              <select class="form-select" id="editOrderStatus" name="orderStatus">
                <option value="0">未接單</option>
                <option value="1">已接單</option>
                <option value="2">準備中</option>
                <option value="3">已完成</option>
                <option value="4">已取消</option>
              </select>
            </div>
            <div class="col-md-6 mb-3">
              <label for="editPaymentStatus" class="form-label">付款狀態</label>
              <select class="form-select" id="editPaymentStatus" name="paymentStatus">
                <option value="0">未付款</option>
                <option value="1">已付款</option>
                <option value="2">退款中</option>
              </select>
            </div>
          </div>
          <div class="mb-3">
            <label for="editCancelReason" class="form-label">取消原因 (若訂單狀態為取消)</label>
            <textarea class="form-control" id="editCancelReason" name="cancelReason" rows="3" placeholder="請輸入取消原因..."></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
        <button type="button" class="btn btn-primary" onclick="saveOrderChanges()">儲存變更</button>
      </div>
    </div>
  </div>
</div>

<!-- Scripts (維持不變) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<script th:src="@{/js/admin/admin-script.js}"></script>
<script th:src="@{/js/admin/datatable.js}"></script>
<script>
  /**
   * 點擊「檢視」按鈕時觸發。
   * @param {number} orderId - 要查詢的訂單 ID。
   */
  function viewOrder(orderId) {
    // ★★★ 已修正：AJAX URL 已對應 Controller 的 /smg/{orderId} 路徑 ★★★
    $.getJSON('/smg/' + orderId)
            .done(function(orderData) {
              // --- 所有資料處理都必須在此 .done() 回呼函式內 ---
              $('#modalOrderId').text(orderData.ordId);
              $('#modalOrderStatus').html(getBadgeHtml(orderData.orderStatus, 'order'));
              $('#modalPaymentStatus').html(getBadgeHtml(orderData.paymentStatus, 'payment'));
              $('#modalOrderTime').text(orderData.ordDate);
              $('#modalPayMethod').text(getPayMethodText(orderData.payMethod));
              $('#modalDeliver').text(getDeliverText(orderData.deliver));
              $('#modalMemberName').text(orderData.memberName);
              $('#modalMemberId').text(orderData.memberId);
              $('#modalStoreName').text(orderData.storeName);
              $('#modalStoreId').text(orderData.storeId);
              $('#modalOrderSum').text('NT$ ' + orderData.ordSum);
              $('#modalPromoDiscount').text('- NT$ ' + orderData.promoDiscount);
              $('#modalCouponDiscount').text('- NT$ ' + orderData.couponDiscount);
              $('#modalActualPayment').text('NT$ ' + orderData.actualPayment);
              $('#modalOrdAddr').text(orderData.ordAddr || '無 (自取)');
              $('#modalRating').html(getRatingStars(orderData.rating));
              $('#modalComment').text(orderData.comment || '無');
              $('#modalCancelReason').text(orderData.cancelReason || '無');

              const detailsBody = $('#modalOrderDetailsBody');
              detailsBody.empty();

              orderData.ordDet.forEach(item => {
                const row = `<tr>
                                    <td>${item.prodName}</td>
                                    <td>${item.ordDesc || '-'}</td>
                                    <td>NT$ ${item.prodPrice}</td>
                                    <td>${item.prodQty}</td>
                                    <td class="fw-bold">NT$ ${item.subtotal}</td>
                                 </tr>`;
                detailsBody.append(row);
              });

              const viewModal = new bootstrap.Modal(document.getElementById('viewOrderModal'));
              viewModal.show();
            })
            .fail(function() {
              alert('錯誤：無法獲取訂單 ' + orderId + ' 的詳細資訊。請檢查網路連線與後端日誌。');
            });
  }

  /**
   * 點擊「編輯」按鈕時觸發。
   * @param {number} orderId - 要編輯的訂單 ID。
   */
  function editOrder(orderId) {
    // ★★★ 已修正：AJAX URL 已對應 Controller 的 /smg/{orderId} 路徑 ★★★
    $.getJSON('/smg/' + orderId)
            .done(function(orderData) {
              $('#editOrdId').val(orderData.ordId);
              $('#editOrderStatus').val(orderData.orderStatus);
              $('#editPaymentStatus').val(orderData.paymentStatus);
              $('#editCancelReason').val(orderData.cancelReason || '');

              const editModal = new bootstrap.Modal(document.getElementById('editOrderModal'));
              editModal.show();
            })
            .fail(function() {
              alert('錯誤：無法獲取訂單 ' + orderId + ' 的資料進行編輯。');
            });
  }

  /**
   * 點擊「儲存變更」按鈕時觸發。
   */
  function saveOrderChanges() {
    const requestData = {
      ordId: parseInt($('#editOrdId').val()),
      orderStatus: parseInt($('#editOrderStatus').val()),
      paymentStatus: parseInt($('#editPaymentStatus').val()),
      cancelReason: $('#editCancelReason').val()
    };

    $.ajax({
      url: '/smg/update-status', // ★★★ 已修正：AJAX URL 已對應 Controller 的 /smg/update-status 路徑 ★★★
      type: 'POST',
      contentType: 'application/json',
      data: JSON.stringify(requestData),
      success: function(response) {
        alert(response.message);
        bootstrap.Modal.getInstance(document.getElementById('editOrderModal')).hide();
        location.reload();
      },
      error: function(xhr) {
        const errorResponse = xhr.responseJSON;
        alert('更新失敗：' + (errorResponse.error || '未知錯誤'));
      }
    });
  }

  /**
   * 從「檢視」彈出視窗中觸發「編輯」功能。
   */
  function editOrderFromModal() {
    const orderId = $('#modalOrderId').text();
    bootstrap.Modal.getInstance(document.getElementById('viewOrderModal')).hide();
    setTimeout(() => { editOrder(orderId); }, 300);
  }

  // --- 輔助函式 (無需變更) ---
  function getPayMethodText(status) {
    switch(status) {
      case 0: return '信用卡'; case 1: return '現金'; case 2: return '第三方支付'; default: return '未知';
    }
  }
  function getDeliverText(status) { return status == 0 ? '外送' : '自取'; }
  function getRatingStars(rating) {
    if (!rating || rating === 0) return '無評價';
    let stars = '';
    for (let i = 0; i < 5; i++) { stars += `<i class="fas fa-star" style="color: ${i < rating ? '#ffc107' : '#e0e0e0'};"></i>`; }
    return stars;
  }
  function getBadgeHtml(status, type) {
    const badges = {
      order: [
        { text: '未接單', class: 'bg-secondary' }, { text: '已接單', class: 'bg-primary' },
        { text: '準備中', class: 'bg-info' },
        { text: '已完成', class: 'bg-success' }, { text: '已取消', class: 'bg-danger' }
      ],
      payment: [
        { text: '未付款', class: 'bg-warning text-dark' }, { text: '已付款', class: 'bg-success' },
        { text: '退款中', class: 'bg-danger' }
      ]
    };
    const badgeInfo = badges[type][status];
    return badgeInfo ? `<span class="badge ${badgeInfo.class}">${badgeInfo.text}</span>` : '';
  }
</script>

</body>
</html>
